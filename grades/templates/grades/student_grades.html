{% extends 'grades/base.html' %}
{% block title %}ثبت نمرات — {{ student.name }}{% endblock %}

{% block extra_head %}
<style>
  .grade-input { width:100%; border-radius:10px; padding:8px; }
  .student-header { display:flex; justify-content:space-between; align-items:center; gap:12px; }
  .student-header .title { font-weight:800; font-size:18px; }
  .avg-live { font-weight:800; padding:8px 12px; border-radius:999px; background:linear-gradient(90deg,#00c853,#00e676); color:white; }
</style>
{% endblock %}

{% block content %}
  <div class="panel">
    <div class="student-header mb-3">
      <div>
        <div class="title">{{ student.name }}</div>
        <div class="muted">شماره: {{ student.student_number }} — کلاس: {{ class.name }}</div>
      </div>
      <div class="text-end">
        <div class="muted small">معدل فعلی دانش‌آموز</div>
        <!-- مقدار معدل که سرور پاس دهد -->
        {% if student_avg is not None %}
          <div class="avg-live" id="studentAvgServer">{{ student_avg }}</div>
        {% else %}
          <div class="avg-live" id="studentAvgServer">—</div>
        {% endif %}
      </div>
    </div>

    {% if not subjects %}
      <div class="alert alert-warning">برای این کلاس هنوز درسی تعریف نشده است. لطفاً ابتدا در هنگام افزودن اولین دانش‌آموز، فهرست دروس را وارد کنید.</div>
    {% else %}
      <form method="post" id="gradesForm">
        {% csrf_token %}
        <div class="row g-3">
          <!-- نمایش فیلدها: فرم داینامیک بر اساس subjects -->
          {% for field in form %}
            <div class="col-md-6">
              <label class="form-label">{{ field.label }}</label>
              {{ field }}
            </div>
          {% endfor %}
        </div>

        <div class="mt-4 d-flex justify-content-between align-items-center">
          <div>
            <a class="btn btn-secondary" href="{% url 'grades:class_detail' class_id=class.id %}">بازگشت</a>
          </div>

          <div class="d-flex align-items-center gap-3">
            <div class="muted small text-end">معدل زنده:</div>
            <div id="studentAvgLive" class="avg-live">—</div>
            <button type="submit" class="btn btn-success">ذخیره نمرات</button>
          </div>
        </div>
      </form>
    {% endif %}
  </div>
{% endblock %}

{% block extra_js %}
<script>
  // محاسبهٔ میانگین زنده از فیلدهای فرم
  (function(){
    const form = document.getElementById('gradesForm');
    if (!form) return;
    const inputs = Array.from(form.querySelectorAll('input[type="number"], input[type="text"], input[type="tel"], input[type="search"], input[type="email"]'));
    // Filter only numeric inputs that represent subjects by name attribute pattern subject_{id}
    const gradeInputs = inputs.filter(i => /^subject_/.test(i.name));
    const liveEl = document.getElementById('studentAvgLive');
    function compute(){
      let sum = 0, count = 0;
      gradeInputs.forEach(inp => {
        const v = parseFloat(inp.value);
        if (!isNaN(v)) { sum += v; count += 1; }
      });
      if (count === 0) {
        liveEl.textContent = '—';
      } else {
        const avg = Math.round((sum / count) * 100) / 100;
        liveEl.textContent = avg.toFixed(2);
      }
    }
    gradeInputs.forEach(i => i.addEventListener('input', compute));
    // محاسبهٔ اولیه با داده‌های موجود
    compute();
    // وقتی فرم ارسال می‌شود، اجازه بده سرور پردازش کند (استاندارد)
  })();
</script>
{% endblock %}
